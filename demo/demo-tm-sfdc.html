<link rel="import" href="../bower_components/tm-app-structure/tm-app-structure.html">
<link rel="import" href="../bower_components/paper-datatable/paper-datatable.html">
<link rel="import" href="../bower_components/paper-datatable/paper-datatable-column.html">
<link rel="import" href="../tm-sfdc-login.html">
<link rel="import" href="../tm-sfdc-services.html">
<link rel="import" href="../tm-sfdc-limits.html">
<link rel="import" href="../tm-sfdc-object.html">
<link rel="import" href="../tm-sfdc-relevant.html">
<link rel="import" href="../tm-sfdc-instance.html">

<dom-module id="demo-tm-sfdc">
  <template>
    <style>
      :host {
        display: inline-block;
      }
      div.page {
        padding: 20px;
        min-width:900px;
        width:900px;
        overflow: scroll;
        margin-left:auto;
        margin-right: auto;
      }
      span.path {
        padding-left: 15px;
      }
      table.limits {
        width: 100%;
      }
      th,td {
        padding:2px;
      }
      th {
        width:50%;
        padding-bottom: 5px;
      }
      table.limits th, table.limits th td {
        text-align: left;
        padding-left: 10px;
      }
      table.limits th:first-of-type, table.limits td:first-of-type {
        text-align: right;
        padding-right: 10px;
      }
      .active-true {
        color:blue;
      }

      table.services th:first-of-type, table.services td:first-of-type{
        text-align: right;
        padding-right: 10px;
      }

      table.services th, table.limits th td {
        text-align: left;
        padding-left: 10px;
      }
    </style>

    <iron-ajax
      auto
      method="GET"
      url="../private/login-data.json"
      handle-as="json"
      last-response="{{loginData}}"></iron-ajax>

    <tm-sfdc-login
      url="[[loginData.auth_url]]"
      client-id="[[loginData.client_id]]"
      client-secret="[[loginData.client_secret]]"
      username="[[loginData.username]]"
      password="[[loginData.password]]"
      response="{{oAuthData}}"
      error-message="{{oAuthErrorMessage}}"></tm-sfdc-login>

    <!-- <tm-sfdc-services
      base-url="[[oAuthData.instance_url]]"
      access-token="[[oAuthData.access_token]]"
      service-list="{{serviceList}}"></tm-sfdc-services> -->

    <!-- <tm-sfdc-limits
      base-url="[[oAuthData.instance_url]]"
      access-token="[[oAuthData.access_token]]"
      limits="{{limits}}"></tm-sfdc-limits> -->

    <!-- <tm-sfdc-object
      base-url="[[oAuthData.instance_url]]"
      access-token="[[oAuthData.access_token]]"
      objects="{{objects}}"></tm-sfdc-object> -->

    <tm-sfdc-relevant
      base-url="[[oAuthData.instance_url]]"
      access-token="[[oAuthData.access_token]]"
      type="Needs_Analysis__c"
      id-map="[[relevantIdMap]]"
      id-list="{{relevantIdList}}"></tm-sfdc-relevant>

    <tm-sfdc-instance
      base-url="[[oAuthData.instance_url]]"
      access-token="[[oAuthData.access_token]]"
      type="Needs_Analysis__c"
      record-id="[[recordId]]"
      record="{{record}}"></tm-sfdc-instance>

    <tm-app-structure app-title="SalesForce Browser" titles="Settings,Services,Limits,Objects,Relevant,Record" selected="0">
      <div class="page">
        <paper-input label="Grant Type" value="password" disabled></paper-input>
        <paper-input label="OAuth2 URL" value="{{loginData.auth_url}}"></paper-input>
        <paper-input label="Client ID" value="{{loginData.client_id}}"></paper-input>
        <paper-input label="Client Secret" value="{{loginData.client_secret}}"></paper-input>
        <paper-input label="User Name" value="{{loginData.username}}"></paper-input>
        <paper-input label="Password" value="{{loginData.password}}"></paper-input>
      </div>
      <div class="page">
        <paper-datatable data="{{serviceList}}" selectable multi-selection>
            <paper-datatable-column header="Name" property="name" sortable><template><span>[[value]]</span></template></paper-datatable-column>
            <paper-datatable-column header="Path" property="path" sortable><template><span>[[value]]</span></template></paper-datatable-column>
        </paper-datatable>
      </div>
      <div class="page">
        <table class="limits">
          <tr><th>Limit</th><th>Remaining</th></tr>
          <template is="dom-repeat" items="[[limits]]" as="limit">
            <tr class$="active-[[_isActive(limit)]]">
              <td>[[limit.name]]</td>
              <td>([[limit.remaining]] of [[limit.max]])</td>
            </tr>
          </template>
        </table>
      </div>
      <div class="page">
        <paper-datatable data="{{objects}}" selectable multi-selection>
          <paper-datatable-column header="name" property="name" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="label" property="label" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="labelPlural" property="labelPlural" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="activateable" property="activateable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="createable" property="createable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="custom" property="custom" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="customSetting" property="customSetting" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="deletable" property="deletable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="deprecatedAndHidden" property="deprecatedAndHidden" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="keyPrefix" property="keyPrefix" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="layoutable" property="layoutable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="mergeable" property="mergeable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="mruEnabled" property="mruEnabled" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="queryable" property="queryable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="replicateable" property="replicateable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="retrieveable" property="retrieveable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="searchable" property="searchable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="triggerable" property="triggerable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="undeletable" property="undeletable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
          <paper-datatable-column header="updateable" property="updateable" sortable><template><span>[[value]]</span></template></paper-datatable-column>
        </paper-datatable>
      </div>
      <div class="page">
        a0ep0000004GkTm
      </div>
      <div class="page">
        <paper-dropdown-menu label="Relevant Object IDs">
          <paper-listbox class="dropdown-content" selected="{{selectedRelivantId}}">
            <template is="dom-repeat" items="[[relevantIdList.recordIds]]" as="item">
              <paper-item>[[item]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
        <template is="dom-repeat" items="[[_generateRecordData(record)]]" as="field">
          <paper-input label="[[field.name]]" value="[[field.value]]"></paper-input>
        </template>
      </div>
    </tm-app-structure>

  </template>
  <script>
    (function(Polymer) {
      Polymer({
        is: 'demo-tm-sfdc',
        properties: {
          loginData: { type: Object, notify: true },
          oAuthData: { type: Object, notify: true },
          oAuthErrorMessage: { type: String, notify: true },
          serviceList: { type: Array, notify: true, value: [] },
          limits: { type: Array, notify: true, value: [] },
          objects: { type: Array, notify: true, value: [] },
          relevantIdMap: { type: Object, notify: true, value: {} },
          relevantIdList: { type: Array, notify: true, value: [] },
          recordId: { type: String, notify:true, computed: '_computeRecordId(relevantIdList,selectedRelivantId)' },
          record: { type: Object, notify: true, value: {} },
          selectedRelivantId: { type: Number, notify: true, value: 0 },
          selectedService: { type: Number, notify: true, value: 0 }
        },
        observers: [
          'debug(recordId)'
        ],
        _computeRecordId: function(relevantIdList,selectedRelivantId) {
          if (relevantIdList.recordIds === undefined) {
            return undefined;
          }
          return relevantIdList.recordIds[selectedRelivantId];
        },
        _generateRecordData: function(record) {
          return Object.keys(record)
            .filter(k => (k !== 'attributes'))
            .map(k => ({name:k, value:record[k]}));
        },
        _isActive: function(limit) {
          return (limit.remaining < limit.max);
        },
        _getServicePath: function(serviceList,selectedService) {
          return (serviceList === undefined || serviceList.length <= selectedService
            ? '' : this.oAuthData.instance_url + '/' + serviceList[selectedService].path);
        },
        debug: function(a,b,c) {
          console.log("--- DEMO DEBUG: ", a,b,c);
        },
        ready: function() {
          console.log('Element demo-tm-sfdc has been created.');
        }
      });
    })(window.Polymer);
  </script>
</dom-module>
